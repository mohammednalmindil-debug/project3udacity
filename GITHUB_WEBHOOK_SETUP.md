# GitHub Webhook Setup Guide for AWS CodeBuild

This guide will help you set up automatic builds in AWS CodeBuild that trigger whenever you push to your GitHub repository.

## Prerequisites

- AWS CLI configured with appropriate permissions
- GitHub repository URL
- Existing IAM role for CodeBuild (CoworkingAnalyticsCodeBuildRole)

## Quick Setup

### Step 1: Run the Setup Script

```powershell
# Replace with your actual GitHub repository URL
.\setup-github-webhook.ps1 -GitHubRepoUrl "https://github.com/your-username/your-repo.git"
```

### Step 2: Add Webhook to GitHub

1. Go to your GitHub repository
2. Click **Settings** → **Webhooks** → **Add webhook**
3. Use the webhook URL provided by the setup script
4. Set **Content type** to `application/json`
5. Select **Just the push event**
6. Check **Active**
7. Click **Add webhook**

### Step 3: Verify Setup

```powershell
.\verify-github-webhook.ps1
```

## Manual Setup (Alternative)

If you prefer to set up manually through the AWS Console:

### 1. Create CodeBuild Project

1. Go to [AWS CodeBuild Console](https://console.aws.amazon.com/codesuite/codebuild/home)
2. Click **Create build project**
3. Configure:
   - **Project name**: `coworking-build`
   - **Source provider**: GitHub
   - **Repository**: Your GitHub repository
   - **Buildspec**: `deployments/buildspec-with-health-check.yaml`

### 2. Enable Webhook

1. In the **Primary source webhook events** section:
   - Select **Rebuild every time a code change is pushed to this repository**
   - Event type: **Push**
   - Add filter:
     - **Type**: HEAD_REF
     - **Pattern**: `^refs/heads/main$`

### 3. Enable CloudWatch Logging

1. In the **Logs** section:
   - **CloudWatch logs**: Enabled
   - **Log group name**: `/aws/codebuild/coworking-build`

### 4. Configure Environment

- **Environment image**: `aws/codebuild/amazonlinux2-x86_64-standard:5.0`
- **Compute type**: `BUILD_GENERAL1_MEDIUM`
- **Privileged mode**: Enabled
- **Service role**: `arn:aws:iam::767398149973:role/CoworkingAnalyticsCodeBuildRole`

## Health Check Feature

The enhanced buildspec includes a health check that:

1. Builds the Docker image
2. Pushes to ECR
3. Runs a test container
4. Tests the `/health_check` endpoint
5. Stops the test container

This ensures your application runs successfully after each build.

## Verification Steps

### Check Build History

1. Go to CodeBuild Console → Build history
2. Look for builds with **Initiator**: `GitHub-Hookshot`
3. Verify build status is **SUCCEEDED**

### Monitor CloudWatch Logs

1. Go to CloudWatch Console → Log groups
2. Navigate to `/aws/codebuild/coworking-build`
3. Review build logs for any issues

### Test the Automation

1. Make a small change to your code
2. Commit and push to the main branch
3. Check CodeBuild console for automatic build trigger
4. Verify the build completes successfully

## Troubleshooting

### Common Issues

**Build not triggering:**

- Verify webhook URL is correct in GitHub
- Check webhook is active in GitHub settings
- Ensure you're pushing to the main branch

**Build failing:**

- Check CloudWatch logs for error details
- Verify ECR permissions
- Ensure buildspec file exists and is valid

**Health check failing:**

- Check if the application starts correctly
- Verify `/health_check` endpoint is accessible
- Review application logs

### Debug Commands

```bash
# Check CodeBuild project status
aws codebuild batch-get-projects --names coworking-build --region us-east-1

# List recent builds
aws codebuild list-builds-for-project --project-name coworking-build --region us-east-1

# Get build details
aws codebuild batch-get-builds --ids <build-id> --region us-east-1
```

## Configuration Files

- `codebuild-project-github.json`: CodeBuild project configuration
- `deployments/buildspec-with-health-check.yaml`: Enhanced buildspec with health check
- `setup-github-webhook.ps1`: Automated setup script
- `verify-github-webhook.ps1`: Verification script

## Security Notes

- Webhook secret is automatically generated by AWS
- IAM role follows least privilege principle
- CloudWatch logs are encrypted at rest
- ECR images are scanned for vulnerabilities

## Next Steps

After successful setup:

1. Monitor build performance and optimize if needed
2. Set up build notifications (SNS/Slack)
3. Configure build badges for your README
4. Consider adding more sophisticated health checks
5. Implement automated deployment to staging/production

---

For additional support, refer to:

- [AWS CodeBuild Documentation](https://docs.aws.amazon.com/codebuild/)
- [GitHub Webhooks Documentation](https://docs.github.com/en/developers/webhooks-and-events/webhooks)
